# Database Migration Plan: digitalme_clean ‚Üí digitalme_fixed

## –ü—Ä–æ–±–ª–µ–º–∞
EnsureCreated() –≤ Entity Framework Core –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç Fluent API mappings (HasColumnName), —Å–æ–∑–¥–∞–≤–∞—è —Å—Ç–æ–ª–±—Ü—ã –ø–æ –∏–º–µ–Ω–∞–º C# properties:
- `PersonalityProfile.IsActive` ‚Üí —Å—Ç–æ–ª–±–µ—Ü `isactive` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –í–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ: `IsActive` (–∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ HasColumnName)

## –†–µ—à–µ–Ω–∏–µ
1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω DatabaseMigrationService**: –ó–∞–º–µ–Ω–µ–Ω EnsureCreated() –Ω–∞ MigrateAsync() –¥–ª—è PostgreSQL
2. üîÑ **–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –ë–î**: `digitalme_fixed` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
3. üîÑ **–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ä–æ–π –ë–î –≤ –Ω–æ–≤—É—é

## –≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –î–µ–ø–ª–æ–π–º–µ–Ω—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚úÖ
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω DatabaseMigrationService.cs
- [x] –û–±–Ω–æ–≤–ª–µ–Ω connection string –Ω–∞ digitalme_fixed
- [x] –ó–∞–ø—É—â–µ–Ω –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º

### –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ üîÑ
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health endpoint: `curl https://digitalme-api-llig7ks2ca-uc.a.run.app/health`
- [ ] –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: `Healthy` (–≤–º–µ—Å—Ç–æ `Unhealthy`)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏

### –≠—Ç–∞–ø 3: –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] –û—Ü–µ–Ω–∏—Ç—å –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö –≤ digitalme_clean
- [ ] –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
  - [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç `scripts/migrate-data-to-fixed-db.sql`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- [ ] –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ:
  - [ ] –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–µ–∂—É—é –ë–î

### –≠—Ç–∞–ø 4: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å registration endpoint
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å login endpoint
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å frontend authentication flow
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ conversations
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å personality profile functionality

### –≠—Ç–∞–ø 5: –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ digitalme_fixed —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º –ë–î
- [ ] –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –£–¥–∞–ª–∏—Ç—å digitalme_clean –ø–æ—Å–ª–µ –ø–µ—Ä–∏–æ–¥–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–¥–µ
```csharp
// ‚ùå –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
await context.Database.EnsureCreatedAsync();

// ‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
await context.Database.MigrateAsync();
```

### Connection Strings
```
// –°—Ç–∞—Ä–∞—è –ë–î (—Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏)
Database=digitalme_clean

// –ù–æ–≤–∞—è –ë–î (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏)
Database=digitalme_fixed
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```sql
-- –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –≤ digitalme_fixed
SELECT COUNT(*) FROM "PersonalityProfiles" WHERE "IsActive" = true;

-- –ò –ù–ï —Ä–∞–±–æ—Ç–∞—Ç—å –≤ digitalme_clean (–æ—à–∏–±–∫–∞: column "isactive" does not exist)
```

## –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ë–î –≤–º–µ—Å—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–π
- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö
- –°—Ç–∞—Ä–∞—è –ë–î –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç–æ–π –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### –†–∏—Å–∫: –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ environment variable
- –ë—ã—Å—Ç—Ä—ã–π rollback –≤–æ–∑–º–æ–∂–µ–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º connection string

### –†–∏—Å–∫: –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**:
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ integration tests
- –ü–æ—ç—Ç–∞–ø–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
1. Health endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Healthy`
2. –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ—à–∏–±–æ–∫ `column "isactive" does not exist`
3. PersonalityProfiles queries —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. Identity system —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
5. Frontend –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API

### ‚ùå –ï—Å–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ:
1. Rollback –Ω–∞ digitalme_clean
2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã
3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- `üîß CRITICAL FIX: EnsureCreated ignores HasColumnName mappings`
- `‚úÖ PostgreSQL database migrated successfully with correct column names`
- Health check —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è
- Migration success/failure events

### –ú–µ—Ç—Ä–∏–∫–∏:
- Health endpoint response time
- API error rates
- Database connection —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
- Migration completion time

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Cloud Run logs
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Cloud SQL connections
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - rollback –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
4. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞