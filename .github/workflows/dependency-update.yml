name: Dependency Updates

on:
  schedule:
    # Check for updates weekly on Mondays at 09:00 UTC
    - cron: '0 9 * * MON'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update .NET Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚀 Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 🔧 Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0'

    - name: 📦 Install dotnet-outdated
      run: dotnet tool install --global dotnet-outdated-tool

    - name: 🔍 Check for Outdated Packages
      run: |
        dotnet-outdated DigitalMe.CI.sln --output json > outdated-packages.json
        cat outdated-packages.json

    - name: 🔄 Update Packages
      run: |
        # Update minor and patch versions automatically
        dotnet-outdated DigitalMe.CI.sln --upgrade --version-lock Minor
        
    - name: 🧪 Test After Updates
      run: |
        dotnet restore DigitalMe.CI.sln
        dotnet build DigitalMe.CI.sln --configuration Release
        dotnet test tests/DigitalMe.Tests.Unit/DigitalMe.Tests.Unit.csproj --configuration Release

    - name: 📝 Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update .NET dependencies'
        title: 'Auto-update .NET Dependencies'
        body: |
          🤖 **Automated Dependency Update**
          
          This PR contains automatic updates to .NET packages:
          
          - Minor and patch version updates only
          - All tests passing
          - Generated by GitHub Actions
          
          **Review the changes and merge if everything looks good.**
          
          ---
          *This PR was created automatically by the dependency-update workflow.*
        branch: chore/dependency-updates
        branch-suffix: timestamp
        delete-branch: true

  check-security-advisories:
    name: Check Security Advisories
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚀 Checkout Code
      uses: actions/checkout@v4

    - name: 🔧 Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0'

    - name: 🛡️ Scan for Vulnerabilities
      run: |
        dotnet list package --vulnerable --include-transitive > vulnerability-scan.txt
        if grep -q "has the following vulnerable packages" vulnerability-scan.txt; then
          echo "::warning::Vulnerable packages detected!"
          cat vulnerability-scan.txt
          exit 1
        else
          echo "✅ No vulnerabilities detected"
        fi

    - name: 📋 Upload Scan Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vulnerability-scan
        path: vulnerability-scan.txt